<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>jujube</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <canvas class="vuMeter"></canvas>
    <main></main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.4.9/Tone.min.js"></script>
    <script src="app.js"></script>
    <script src="inst.js"></script>
    <script src="meter.js"></script>
    <script>
      const app = Elm.Main.init({ node: document.querySelector("main") });
      let drumKit;
      let tracks = {};

      function setTrack(id, sequence, handler) {
        if (tracks.hasOwnProperty(id)) {
          tracks[id]
            .cancel()
            .stop()
            .removeAll()
            .dispose();
        }
        tracks[id] = new Tone.Sequence(handler, sequence).start(0);
        return tracks[id];
      }

      function drumTrack(id, sequence) {
        const compressor = new Tone.Compressor(-6);
        const feedbackDelay = new Tone.FeedbackDelay("16n", 0.1);

        setTrack(id, sequence, function(time, note) {
          const hit = drumKit
            .get(note.pitch)
            .start(time)
            .chain(compressor, feedbackDelay, Tone.Master);
        }).probability = 0.99;
      }

      function loadDrums(samples) {
        return new Promise((resolve, reject) => {
          const drums = new Tone.Players(
            samples.reduce(function(acc, sample) {
              return { ...acc, [sample]: sample };
            }, {}),
            function() {
              resolve(drums);
            }
          );
        });
      }

      app.ports.load.subscribe(function() {
        Tone.start();
        loadDrums(instruments.drumSamples).then(function(result) {
          drumKit = result;
          app.ports.ready.send(true);
        });
      });

      app.ports.start.subscribe(function(muted) {
        Tone.Master.chain(new Tone.Limiter(-6));
        Tone.Transport.start();
        vuMeter(Tone.Master);
      });

      app.ports.stop.subscribe(function() {
        Tone.Transport.stop();
        Tone.Transport.cancel();
        Tone.Transport.position = 0;
      });

      app.ports.setBpm.subscribe(function(bpm) {
        Tone.Transport.bpm.value = bpm;
      });

      app.ports.setDrumTracks.subscribe(function(drums) {
        drumTrack("kick", drums.kick.sequence);
        drumTrack("snare", drums.snare.sequence);
        drumTrack("hihat", drums.hihat.sequence);
      });

      app.ports.setTrack.subscribe(function(track) {
        const panVol = new Tone.PanVol(track.pan, track.volume);
        const pingPong = new Tone.PingPongDelay("8n", 0);
        const instrument = new Tone.PolySynth(
          4,
          Tone.Synth,
          instruments[track.instrument]
        ).chain(pingPong, panVol, Tone.Master);

        setTrack(track.id, track.sequence, function(time, note) {
          instrument.triggerAttackRelease(note.pitch, note.dur, time, note.vel);
        }).probability = track.probability;
      });
    </script>
  </body>
</html>
