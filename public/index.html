<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>jujube</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <canvas class="vuMeter"></canvas>
    <main></main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.4.9/Tone.min.js"></script>
    <script src="app.js"></script>
    <script src="inst.js"></script>
    <script src="meter.js"></script>
    <script>
      const app = Elm.Main.init({ node: document.querySelector("main") });
      let drumKit;
      let tracks = {};

      function setTrack(id, sequence, handler) {
        if (tracks.hasOwnProperty(id)) {
          tracks[id].mute = true;
          tracks[id].probability = 0;
          tracks[id].loop = 0;
          tracks[id].callback = () => {};
          tracks[id]
            .cancel(0)
            .stop(0)
            .removeAll()
            .dispose();
        }
        delete tracks[id];
        tracks[id] = new Tone.Sequence(handler, sequence).start(0);
        return tracks[id];
      }

      function drumTrack(id, sequence) {
        setTrack(id, sequence, function(time, note) {
          drumKit.get(note.pitch).start(time);
        }).probability = 0.99;
      }

      function setupDrumKit(samples) {
        const panVol = new Tone.PanVol(0, -2);
        const compressor = new Tone.Compressor(-16, 10);
        const feedbackDelay = new Tone.FeedbackDelay("16n", 0.1);
        // const reverb = new Tone.Freeverb(0.5, 10000);
        // reverb.wet = 0.2;

        return new Promise(resolve => {
          new Tone.Players(
            samples.reduce((acc, sample) => ({ ...acc, [sample]: sample }), {}),
            resolve
          ).chain(panVol, feedbackDelay, compressor, Tone.Master);
        });
      }

      app.ports.load.subscribe(function() {
        Tone.start();
        Tone.Master.chain(new Tone.Limiter(-6));
        vuMeter(Tone.Master);
        setupDrumKit(instruments.drumSamples).then(function(result) {
          drumKit = result;
          app.ports.ready.send(true);
        });
      });

      app.ports.start.subscribe(function() {
        Tone.Transport.start();
        Tone.Transport.scheduleRepeat(function(time) {
          app.ports.bar.send(true);
        }, "4m");
      });

      app.ports.stop.subscribe(function() {
        Tone.Transport.stop();
        Tone.Transport.position = 0;
      });

      app.ports.setBpm.subscribe(function(bpm) {
        Tone.Transport.bpm.value = bpm;
      });

      app.ports.setDrumTracks.subscribe(function(drums) {
        drumTrack("kick", drums.kick.sequence);
        drumTrack("snare", drums.snare.sequence);
        drumTrack("hihat", drums.hihat.sequence);
      });

      app.ports.setTrack.subscribe(function(track) {
        const panVol = new Tone.PanVol(track.pan, track.volume);
        const pingPong = new Tone.PingPongDelay("8n", 0);
        const instrument = new Tone.PolySynth(
          4,
          Tone.Synth,
          instruments[track.instrument]
        ).chain(pingPong, panVol, Tone.Master);

        setTrack(track.id, track.sequence, function(time, note) {
          instrument.triggerAttackRelease(note.pitch, note.dur, time, note.vel);
        }).probability = track.probability;
      });
    </script>
  </body>
</html>
