<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>jujube</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <canvas class="vuMeter"></canvas>
    <main></main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.4.9/Tone.min.js"></script>
    <script src="app.js"></script>
    <script src="inst.js"></script>
    <script src="meter.js"></script>
    <script>
      const app = Elm.Main.init({ node: document.querySelector("main") });
      let drumKit;
      let tracks = {};

      function drumTrack(drums, sequence) {
        // FIXME: add to tracks
        const compressor = new Tone.Compressor(-6);
        const feedbackDelay = new Tone.FeedbackDelay("16n", 0.1);
        const track = new Tone.Sequence(function(time, note) {
          const hit = drums
            .get(note.pitch)
            .start(time)
            .chain(compressor, feedbackDelay, Tone.Master);
        }, sequence).start(0);
        track.probability = 0.99;
        return track;
      }

      function loadDrums(samples) {
        return new Promise((resolve, reject) => {
          const drums = new Tone.Players(
            samples.reduce(function(acc, sample) {
              return { ...acc, [sample]: sample };
            }, {}),
            function() {
              resolve(drums);
            }
          );
        });
      }

      app.ports.load.subscribe(function() {
        Tone.start();
        loadDrums(instruments.drumSamples).then(function(result) {
          drumKit = result;
          app.ports.ready.send(true);
        });
      });

      app.ports.start.subscribe(function(muted) {
        Tone.Master.chain(new Tone.Limiter(-6));
        Tone.Transport.start();
        vuMeter(Tone.Master);
      });

      app.ports.stop.subscribe(function() {
        Tone.Transport.stop();
        Tone.Transport.cancel();
        Tone.Transport.position = 0;
      });

      app.ports.setBpm.subscribe(function(bpm) {
        Tone.Transport.bpm.value = bpm;
      });

      app.ports.setDrumTracks.subscribe(function(drums) {
        const samples = [
          drums.kick.sample,
          drums.snare.sample,
          drums.hihat.sample
        ];
        loadDrums(samples).then(function(kit) {
          drumTrack(kit, drums.kick.sequence);
          drumTrack(kit, drums.snare.sequence);
          drumTrack(kit, drums.hihat.sequence);
        });
      });

      app.ports.setTrack.subscribe(function(track) {
        const panVol = new Tone.PanVol(track.pan, track.volume);
        const pingPong = new Tone.PingPongDelay("8n", 0);
        const instrument = new Tone.PolySynth(
          4,
          Tone.Synth,
          instruments[track.instrument]
        ).chain(pingPong, panVol, Tone.Master);

        if (tracks.hasOwnProperty(track.id)) {
          tracks[track.id]
            .cancel()
            .stop()
            .removeAll()
            .dispose();
        }

        tracks[track.id] = new Tone.Sequence(function(time, note) {
          instrument.triggerAttackRelease(note.pitch, note.dur, time, note.vel);
        }, track.sequence).start(0);

        tracks[track.id].probability = track.probability;
      });
    </script>
  </body>
</html>
